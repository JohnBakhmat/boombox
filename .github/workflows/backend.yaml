name: Backend CI/CD

on:
	push:
		branches:
			- main
			- develop
		paths:
			- 'backend/**'
			- 'shared/**'
			- 'package.json'
			- 'bun.lock'
			- '.github/workflows/backend.yaml'
	pull_request:
		branches:
			- main
			- develop
		paths:
			- 'backend/**'
			- 'shared/**'
			- 'package.json'
			- 'bun.lock'
			- '.github/workflows/backend.yaml'

env:
	REGISTRY: ghcr.io
	IMAGE_NAME: ${{ github.repository }}-backend

jobs:
	build-and-test:
		runs-on: ubuntu-latest
		permissions:
			contents: read

		steps:
			- name: Checkout code
			  uses: actions/checkout@v4

			- name: Setup Bun
			  uses: oven-sh/setup-bun@v2
			  with:
				  bun-version: latest

			- name: Cache Bun dependencies
			  uses: actions/cache@v4
			  with:
				  path: ~/.bun/install/cache
				  key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb') }}
				  restore-keys: |
					  ${{ runner.os }}-bun-

			- name: Install dependencies
			  run: bun install --frozen-lockfile

			- name: Run backend tests
			  run: bun --filter @boombox/backend test
			  working-directory: ./

			- name: Build backend
			  run: bun --filter @boombox/backend build
			  working-directory: ./

	docker-publish:
		runs-on: ubuntu-latest
		needs: build-and-test
		if: github.ref == 'refs/heads/main' && github.event_name == 'push'
		permissions:
			contents: read
			packages: write

		steps:
			- name: Checkout code
			  uses: actions/checkout@v4

			- name: Set up Docker Buildx
			  uses: docker/setup-buildx-action@v3

			- name: Log in to GitHub Container Registry
			  uses: docker/login-action@v3
			  with:
				  registry: ${{ env.REGISTRY }}
				  username: ${{ github.actor }}
				  password: ${{ secrets.GITHUB_TOKEN }}

			- name: Extract metadata (tags, labels)
			  id: meta
			  uses: docker/metadata-action@v5
			  with:
				  images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
				  tags: |
					  type=raw,value=latest,enable={{is_default_branch}}
					  type=sha,prefix=sha-,format=short

			- name: Build and push Docker image
			  uses: docker/build-push-action@v5
			  with:
				  context: .
				  file: ./backend/Dockerfile
				  push: true
				  tags: ${{ steps.meta.outputs.tags }}
				  labels: ${{ steps.meta.outputs.labels }}
				  cache-from: type=gha
				  cache-to: type=gha,mode=max
